#!/usr/bin/env php
<?php

declare(strict_types=1);

use Symfony\Component\Console\Application;
use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Filesystem\Path;
use Vstelmakh\Stasis\Command\GenerateCommand;
use Vstelmakh\Stasis\Command\ServerCommand;
use Vstelmakh\Stasis\Config\ConfigLoader;

if (isset($GLOBALS['_composer_autoload_path'])) {
    $autoloadPath = $GLOBALS['_composer_autoload_path'];
} else {
    $files = [__DIR__ . '/../../autoload.php', __DIR__ . '/../vendor/autoload.php', __DIR__ . '/vendor/autoload.php'];
    foreach ($files as $file) {
        if (file_exists($file)) {
            $autoloadPath = $file;
            break;
        }
    }
}
require_once $autoloadPath;

$autoloadPath = Path::canonicalize($autoloadPath);
$projectRoot = dirname($autoloadPath, 2);

$application = new Application('Stasis');

$application->getDefinition()->addOption(new InputOption(
    '--config',
    null,
    InputOption::VALUE_REQUIRED,
    'Path to config file',
    ConfigLoader::DEFAULT_CONFIG,
));

$input = new ArgvInput();
$configPath = $input->getParameterOption('--config', null);

$configLoader = new ConfigLoader($projectRoot);
$config = $configLoader->load($configPath);

$application->get('help')->setHidden(true);
$application->get('list')->setHidden(true);
$application->get('completion')->setHidden(true);

$application->addCommands([
    new GenerateCommand($config),
    new ServerCommand($config),
]);

$application->run();
